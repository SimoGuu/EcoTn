<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Silex v3.6.1">
    <link rel="stylesheet" href="css/login.css" />
    <link rel="stylesheet" href="css/style.css" />


    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
</head>

<body class="sfondo">


    <div id="blocco_form" class="card">
        <img id="immagine_login" src="Immagini/icona_utente.jpg" />

        <!-- pulsanti login -->
        <div id="decorazione">
                <img class="immagine_SPID_CIE" src="Immagini/LogInSPID.png" onclick="controllaLog()" />

                <img class="immagine_SPID_CIE" src="Immagini/LogInCIE.png" />
        </div>

    </div>









    <script>
        let apiUrl = (window.location.hostname === "localhost") ? "http://localhost:8080" : "https://ecotn-5fc1.onrender.com";

        //Set tema
        if (localStorage.getItem("theme") == "dark") {
            document.body.classList.add("dark");
        } else {
            document.body.classList.remove("dark");
        }


        if (localStorage.getItem("utenteId") != null) {
            //window.location.href="selezione-impianto.html";
        }

        
        /**
         * Funzione controllo se utente ha fatto login con SPID.
         * Semplicemente restituisce true se login ok, altrimenti false.
         *
         * uso:
         */


        async function controllaLog() {
            let check = await checkLogin();
            if (check) {
                let profile = await getUserProfile();
                console.log(profile);
                localStorage.setItem("utenteId", profile["localEntity"]["_id"]);
                localStorage.setItem("isDipendente", profile["localEntity"]["isDipendente"]);
                window.location.href = "selezione-impianto.html";
            } else {
                redirectLogin();
                return;
            }
        }

        async function checkLogin() {
            return new Promise(async (resolve, reject) => {
                try {
                    const response = await fetch(apiUrl + "/api/v1/spid/login", {
                        method: "HEAD",
                        credentials: "include"
                    });

                    if (response.status === 200) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                } catch (error) {
                    resolve(false);
                }
            });
        }

        /**
         * Rimanda utente a login.
         */
        function redirectLogin() {
            window.location.href = apiUrl + "/api/v1/spid/login";
        }

        /**
         * Carica profilo utente.
         *
         * {
         *     "spidCode": "XXXX1AH264KWP1",
         *     "name": "LEONARDO ESSAM",
         *     "familyName": "DEI ROSSI",
         *     "fiscalNumber": "TINIT-DRSLRD05D05F241U",
         *     "domicileStreetAddress": "Viale",
         *     "address": "Trieste 13",
         *     "domicilePostalCode": "38122",
         *     "domicileMunicipality": "L378",
         *     "domicileProvince": "TN",
         *     "domicileNation": "ITA"
         * }
         */
        async function getUserProfile() {
            return new Promise(async (resolve, reject) => {
                try {
                    const response = await fetch(apiUrl + "/api/v1/spid/login", {
                        method: "GET",
                        credentials: "include",
                        headers: {
                            "Accept": "application/json"
                        }
                    });

                    if (!response.ok) {
                        resolve(null);
                    }

                    const data = await response.json();
                    resolve(data["result"]);
                } catch (error) {
                    resolve(null);
                }
            });
        }



    </script>
</body>

</html>