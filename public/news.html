<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Silex v3.6.1">
    <link rel="stylesheet" href="css/news.css" />
    <link rel="stylesheet" href="css/style.css" />




    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
</head>

<body class="sfondo">
    <div class="titolo_block" data-lingua="titolo_news"></div>


    <div id="div_chiavi">
        <p class="testo_impostazioni" data-lingua="input_chiavi"></p>
    </div>



    <div class="box_news" id="box_news"></div>

    <script src="scripts/translations.js"></script>
    <script>
        let apiUrl = (window.location.hostname === "localhost") ? "http://localhost:8080" : "https://ecotn-5fc1.onrender.com";

        cambiaLingua();
        //Set tema
        if (localStorage.getItem("theme") == "dark") {
            document.body.classList.add("dark");
        } else {
            document.body.classList.remove("dark");
        }

        creaSelect();
        async function creaSelect() {

            const div = document.getElementById("div_chiavi");

            const response = await fetch(apiUrl + "/api/v1/keys");
            const chiavi = await response.json();

            const select = document.createElement("select");
            select.id = "select_chiavi";

            const optionDefault = document.createElement("option");
            optionDefault.value = "";
            optionDefault.textContent = translations[localStorage.getItem("lingua") || "it"].tutte_chiavi;
            select.appendChild(optionDefault);

            chiavi.forEach(chiave => {
                const option = document.createElement("option");
                option.value = chiave["_id"];
                option.textContent = chiave["nome"];
                select.appendChild(option);
            });

            select.addEventListener("change", function () {
                getNews(this.value);
            });

            div.appendChild(select);
        }

        getNews();
        // Funzione per ottenere le case dal backend
        async function getNews(chiave = "") {
            try {
                let url = "/api/v1/news";
                if (chiave != "") {
                    url = "/api/v1/keys/" + chiave + "/news";
                }
                const response = await fetch(apiUrl + url);

                // Controlla se la risposta Ã¨ OK
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                // Trasforma la risposta in JSON
                const notizie = await response.json();
                displayNotizie(notizie);

            } catch (error) {
                console.error("Errore nel recupero delle case:", error);
            }
        }

      
        function displayNotizie(notizie) {
            const container = document.getElementById("box_news");
            container.innerHTML = ""; 

            notizie.forEach(notizia => {


                const div = document.createElement("div");
                div.classList.add("card");
                div.id = `abitazione-${notizia._id}`;

                div.addEventListener('click', function () {


                    localStorage.setItem('idNotizia', notizia._id);
                    window.location.href = 'articolo.html';

                });

                var immagine = document.createElement("img");
                immagine.classList.add("img_news");

                const source = notizia.immagine === undefined ? "Immagini/impianto_placeholder.jpg" : notizia.immagine;
                immagine.src = source;
                immagine.style.width = "90%";


                var titolo = document.createElement("h2");
                titolo.textContent = `${notizia.titolo}`;

                div.appendChild(titolo);
                div.appendChild(immagine);


                if (notizia.chiavi.length > 0) {
                    const footer = document.createElement("div");
                    footer.textContent = translations[localStorage.getItem("lingua") || "it"].chiavi_card + " " + notizia.chiavi.join(" #");
                    div.appendChild(footer);
                }

                container.appendChild(div);
            });
        }

    </script>
</body>

</html>